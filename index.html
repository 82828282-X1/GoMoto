<!DOCTYPE html>
<html>
<head>
    <title>Moving Vehicles Demo</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDvMFiXrKuTBCoDhsxxoYJ2BJiUgFEgrFg&libraries=places"></script>
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }

        .popup {
            text-align: center;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .popup img {
            width: 80px;
            height: 80px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<div>
    <input id="pickupInput" type="text" placeholder="Enter pickup location">
    <input id="dropoffInput" type="text" placeholder="Enter drop-off location">
    <button onclick="confirmRide()">Confirm Ride</button>
</div>
<div id="map"></div>

<script>
    let map;
    const lilongweCenter = { lat: -13.9833, lng: 33.7833 }; // Lilongwe
    const vehicles = []; // Array to store vehicles
    const vehicleIcons = [
        "http://maps.google.com/mapfiles/ms/icons/red-car.png", // Car icon
        "http://maps.google.com/mapfiles/ms/icons/motorcycle.png" // Bike icon
    ];
    let pickupMarker, dropoffMarker;

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: lilongweCenter,
            zoom: 14,
        });

        // Initialize autocomplete inputs limited to Malawi
        const autocompleteOptions = { componentRestrictions: { country: "mw" } };
        const pickupInput = new google.maps.places.Autocomplete(
            document.getElementById("pickupInput"),
            autocompleteOptions
        );

        const dropoffInput = new google.maps.places.Autocomplete(
            document.getElementById("dropoffInput"),
            autocompleteOptions
        );

        // Add listeners to set markers
        pickupInput.addListener("place_changed", () => {
            const place = pickupInput.getPlace();
            if (place.geometry) {
                setMarker("pickup", place.geometry.location);
            }
        });

        dropoffInput.addListener("place_changed", () => {
            const place = dropoffInput.getPlace();
            if (place.geometry) {
                setMarker("dropoff", place.geometry.location);
            }
        });

        // Generate random vehicles
        for (let i = 0; i < 5; i++) {
            addMovingVehicle();
        }
    }

    // Add a vehicle and make it move
    function addMovingVehicle() {
        const startPosition = getRandomPosition();
        const vehicle = new google.maps.Marker({
            position: startPosition,
            map: map,
            icon: vehicleIcons[Math.floor(Math.random() * vehicleIcons.length)], // Random car/bike icon
        });
        vehicles.push(vehicle);
        moveVehicle(vehicle);
    }

    // Move vehicle
    function moveVehicle(vehicle) {
        const newPosition = getRandomPosition();
        const animationDuration = 5000; // 5 seconds
        const startTime = performance.now();
        const startLatLng = vehicle.getPosition();
        const endLatLng = new google.maps.LatLng(newPosition.lat, newPosition.lng);

        function animate(time) {
            const progress = Math.min((time - startTime) / animationDuration, 1);
            const lat = startLatLng.lat() + (endLatLng.lat() - startLatLng.lat()) * progress;
            const lng = startLatLng.lng() + (endLatLng.lng() - startLatLng.lng()) * progress;

            vehicle.setPosition(new google.maps.LatLng(lat, lng));
            if (progress < 1) {
                requestAnimationFrame(animate);
            } else {
                moveVehicle(vehicle); // Move to a new position
            }
        }
        requestAnimationFrame(animate);
    }

    // Random position generator
    function getRandomPosition() {
        const latOffset = (Math.random() - 0.5) * 0.05;
        const lngOffset = (Math.random() - 0.5) * 0.05;
        return { lat: lilongweCenter.lat + latOffset, lng: lilongweCenter.lng + lngOffset };
    }

    // Set pickup and dropoff markers
    function setMarker(type, position) {
        const icon = {
            url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
            labelOrigin: new google.maps.Point(15, 10),
        };
        const label = type === "pickup" ? "A" : "B";

        if (type === "pickup") {
            if (pickupMarker) pickupMarker.setMap(null);
            pickupMarker = new google.maps.Marker({
                position,
                map,
                icon,
                label,
            });
        } else {
            if (dropoffMarker) dropoffMarker.setMap(null);
            dropoffMarker = new google.maps.Marker({
                position,
                map,
                icon,
                label,
            });
        }
        map.panTo(position);
    }

    // Confirmation popup with animated icon
    function confirmRide() {
        if (!pickupMarker || !dropoffMarker) {
            alert("Please enter both pickup and drop-off locations!");
            return;
        }

        const popupContent = `
            <div class="popup">
                <img src="https://raw.githubusercontent.com/88448844/Driver-/refs/heads/main/driver%202.gif?token=GHSAT0AAAAAAC36UOH77SAQCWM2FR5AZOM2Z27PDFQ" 
                     alt="Driver on the way">
                <h3>Ride Confirmed!</h3>
                <p>Your driver is on the way!</p>
            </div>
        `;
        const popup = document.createElement("div");
        popup.innerHTML = popupContent;
        document.body.appendChild(popup);

        // Remove popup after 3 seconds
        setTimeout(() => popup.remove(), 3000);
    }

    window.onload = initMap;
</script>
</body>
</html>